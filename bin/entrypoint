#!/bin/sh -l
set -e

setup-ssh

action="$1"
action_arg="$2"

if [ "$action" = "review-apps:create" ] || [ "$action" = 'review-apps:destroy' ]; then
    if [ -z "$action_arg" ]; then
        log-error "No review app name specified"
        exit 1
    fi
fi

app_name="$(parse-app-name)"
review_app_name="${action_arg}"
ssh_remote="ssh://dokku@$(parse-ssh-host):$(parse-ssh-port)"

if [ "$action" = "review-app:destroy" ]; then
    log-info "Destroying review app '${review_app_name}'"
    ssh "$ssh_remote" -- --force apps:destroy "$review_app_name"
    exit 0
fi

if [ -n "$action" ] && [ "$action" != "review-apps:create" ]; then
    log-error "Invalid action specified"
    exit 1
fi

if [ "$action" = "review-apps:create" ]; then
    log-info "Ensuring review app '${review_app_name}' exists"
    ssh "$ssh_remote" -- apps:clone --skip-deploy --ignore-existing "$app_name" "$review_app_name"
fi

log-info "Pushing to Dokku Host";

if [ -n "$review_app_name" ] && [ "$app_name" != "$review_app_name" ]; then
    GIT_REMOTE_URL="${GIT_REMOTE_URL%"/$app_name"}/${review_app_name}"
fi

git push "$GIT_PUSH_FLAGS" "$GIT_REMOTE_URL" "$GITHUB_SHA:refs/heads/$BRANCH" --force
